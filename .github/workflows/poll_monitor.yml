name: Poll Monitor â€” Check & Dispatch (no-X)

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

permissions:
  contents: read
  actions: write    # needed to create workflow_dispatch

jobs:
  check-and-dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Quick read of poll.json and decide
        id: decide
        uses: actions/github-script@v6
        with:
          script: |
            const path = "data/poll.json";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              const res = await github.rest.repos.getContent({ owner, repo, path });
              const buff = Buffer.from(res.data.content, "base64");
              const json = JSON.parse(buff.toString("utf-8"));

              const stage1 = json.stage1 || (json.poll && json.poll.stage1) || null;
              if (!stage1) {
                core.info("No stage1 present -> nothing to do");
                return { should_run: "false" };
              }

              // prefer explicit closesAt
              if (stage1.closesAt) {
                const closes = Date.parse(stage1.closesAt);
                if (!isNaN(closes) && Date.now() >= closes) {
                  return { should_run: "true" };
                } else {
                  return { should_run: "false" };
                }
              }

              if (stage1.createdAt) {
                const created = Date.parse(stage1.createdAt);
                if (!isNaN(created) && (Date.now() - created) >= 24*3600*1000) {
                  return { should_run: "true" };
                }
              }

              return { should_run: "false" };
            } catch (err) {
              core.info("Quick-check failed; skipping heavy job: " + String(err));
              return { should_run: "false" };
            }
      - name: Trigger apply_poll (only if needed)
        if: steps.decide.outputs.should_run == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // workflow file name of the heavy job
            const workflow_id = 'apply_poll.yml';
            // dispatch to main
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id,
              ref: 'main',
              inputs: {
                reason: 'stage1_closed_by_monitor'
              }
            });
            core.info("Dispatched apply_poll workflow");
